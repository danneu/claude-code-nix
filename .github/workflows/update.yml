name: Update Claude Code

on:
  schedule:
    - cron: '0 * * * *'  # Run hourly
  workflow_dispatch:

jobs:
  update:
    runs-on: macos-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Check for native updates
        id: check-native
        run: |
          set -euo pipefail

          # Derive GCS bucket URL from official install.sh redirect
          REDIRECT_HEADERS=$(curl -fsSI https://claude.ai/install.sh) || {
            echo "Error: Failed to fetch https://claude.ai/install.sh"
            exit 1
          }
          BOOTSTRAP_URL=$(echo "$REDIRECT_HEADERS" | grep -i '^location:' | awk '{print $2}' | tr -d '\r')
          if [ -z "$BOOTSTRAP_URL" ]; then
            echo "Error: No redirect found from https://claude.ai/install.sh"
            exit 1
          fi
          GCS_BUCKET="${BOOTSTRAP_URL%/bootstrap.sh}"

          STABLE_REMOTE=$(curl -fsSL "$GCS_BUCKET/stable")
          LATEST_REMOTE=$(curl -fsSL "$GCS_BUCKET/latest")
          STABLE_LOCAL=$(grep -A2 '^  stable = {' sources.nix | grep 'version' | sed 's/.*"\([^"]*\)".*/\1/')
          LATEST_LOCAL=$(grep -A2 '^  latest = {' sources.nix | grep 'version' | sed 's/.*"\([^"]*\)".*/\1/')

          echo "stable_remote=$STABLE_REMOTE" >> $GITHUB_OUTPUT
          echo "latest_remote=$LATEST_REMOTE" >> $GITHUB_OUTPUT
          echo "stable_local=$STABLE_LOCAL" >> $GITHUB_OUTPUT
          echo "latest_local=$LATEST_LOCAL" >> $GITHUB_OUTPUT

          if [ "$STABLE_REMOTE" != "$STABLE_LOCAL" ] || [ "$LATEST_REMOTE" != "$LATEST_LOCAL" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for npm updates
        id: check-npm
        run: |
          set -euo pipefail

          # Fetch dist-tags from npm registry
          DIST_TAGS=$(curl -fsSL "https://registry.npmjs.org/@anthropic-ai/claude-code" | sed -n 's/.*"dist-tags":\({[^}]*}\).*/\1/p')
          NPM_STABLE_REMOTE=$(echo "$DIST_TAGS" | sed -n 's/.*"stable":"\([^"]*\)".*/\1/p')
          NPM_LATEST_REMOTE=$(echo "$DIST_TAGS" | sed -n 's/.*"latest":"\([^"]*\)".*/\1/p')

          # Get local versions from sources.nix
          NPM_STABLE_LOCAL=$(sed -n '/^  npm = {/,/^  };/p' sources.nix | grep -A2 'stable = {' | grep 'version' | sed 's/.*"\([^"]*\)".*/\1/')
          NPM_LATEST_LOCAL=$(sed -n '/^  npm = {/,/^  };/p' sources.nix | grep -A2 'latest = {' | grep 'version' | sed 's/.*"\([^"]*\)".*/\1/')

          echo "npm_stable_remote=$NPM_STABLE_REMOTE" >> $GITHUB_OUTPUT
          echo "npm_latest_remote=$NPM_LATEST_REMOTE" >> $GITHUB_OUTPUT
          echo "npm_stable_local=$NPM_STABLE_LOCAL" >> $GITHUB_OUTPUT
          echo "npm_latest_local=$NPM_LATEST_LOCAL" >> $GITHUB_OUTPUT

          if [ "$NPM_STABLE_REMOTE" != "$NPM_STABLE_LOCAL" ] || [ "$NPM_LATEST_REMOTE" != "$NPM_LATEST_LOCAL" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Run native update script
        if: steps.check-native.outputs.needs_update == 'true'
        run: ./scripts/update-native.sh

      - name: Run npm update script
        if: steps.check-npm.outputs.needs_update == 'true'
        run: ./scripts/update-npm.sh

      - name: Build PR title and body
        if: steps.check-native.outputs.needs_update == 'true' || steps.check-npm.outputs.needs_update == 'true'
        id: pr-info
        run: |
          TITLE_PARTS=""
          BODY_LINES=""

          if [ "${{ steps.check-native.outputs.needs_update }}" = "true" ]; then
            TITLE_PARTS="native: stable ${{ steps.check-native.outputs.stable_remote }}, latest ${{ steps.check-native.outputs.latest_remote }}"
            BODY_LINES="- native stable: ${{ steps.check-native.outputs.stable_local }} → ${{ steps.check-native.outputs.stable_remote }}"
            BODY_LINES="$BODY_LINES
          - native latest: ${{ steps.check-native.outputs.latest_local }} → ${{ steps.check-native.outputs.latest_remote }}"
          fi

          if [ "${{ steps.check-npm.outputs.needs_update }}" = "true" ]; then
            if [ -n "$TITLE_PARTS" ]; then
              TITLE_PARTS="$TITLE_PARTS; npm: stable ${{ steps.check-npm.outputs.npm_stable_remote }}, latest ${{ steps.check-npm.outputs.npm_latest_remote }}"
            else
              TITLE_PARTS="npm: stable ${{ steps.check-npm.outputs.npm_stable_remote }}, latest ${{ steps.check-npm.outputs.npm_latest_remote }}"
            fi
            if [ -n "$BODY_LINES" ]; then
              BODY_LINES="$BODY_LINES
          - npm stable: ${{ steps.check-npm.outputs.npm_stable_local }} → ${{ steps.check-npm.outputs.npm_stable_remote }}
          - npm latest: ${{ steps.check-npm.outputs.npm_latest_local }} → ${{ steps.check-npm.outputs.npm_latest_remote }}"
            else
              BODY_LINES="- npm stable: ${{ steps.check-npm.outputs.npm_stable_local }} → ${{ steps.check-npm.outputs.npm_stable_remote }}
          - npm latest: ${{ steps.check-npm.outputs.npm_latest_local }} → ${{ steps.check-npm.outputs.npm_latest_remote }}"
            fi
          fi

          echo "title=update $TITLE_PARTS" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "Automated update." >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "$BODY_LINES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        id: create-pr
        if: steps.check-native.outputs.needs_update == 'true' || steps.check-npm.outputs.needs_update == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: ${{ steps.pr-info.outputs.title }}
          title: ${{ steps.pr-info.outputs.title }}
          body: ${{ steps.pr-info.outputs.body }}
          branch: update-claude
          delete-branch: true

      - name: Enable auto-merge
        if: steps.create-pr.outputs.pull-request-number
        run: gh pr merge --auto --squash "${{ steps.create-pr.outputs.pull-request-number }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
